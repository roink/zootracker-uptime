# /etc/systemd/system/nginx.service.d/hardening.conf

[Service]
# Core sandboxing
NoNewPrivileges=yes
RestrictSUIDSGID=yes
RestrictNamespaces=yes
ProtectProc=invisible
ProcSubset=pid
PrivateTmp=yes
PrivateDevices=yes
ProtectControlGroups=yes
ProtectKernelModules=yes
ProtectKernelTunables=yes
ProtectKernelLogs=yes
ProtectClock=yes
ProtectHostname=yes
LockPersonality=yes
MemoryDenyWriteExecute=yes
RestrictRealtime=yes
SystemCallArchitectures=native
UMask=0077

# Capabilities: bind 80/443 only
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SETGID CAP_SETUID
AmbientCapabilities=

# File system protection:
# Use 'full' (not 'strict') to avoid fighting with many read-only mounts,
# while still making /usr and /etc read-only. Leave /var writable.
ProtectSystem=full
ProtectHome=read-only

# Allow nginx to write only where it legitimately needs to
ReadWritePaths=/var/log/nginx /var/cache/nginx /var/lib/nginx /run/nginx
RuntimeDirectory=nginx
RuntimeDirectoryMode=0755


# Networking families nginx needs
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6

# Seccomp: start with the recommended allowlist and deny some high-risk classes
SystemCallFilter=@system-service
SystemCallFilter=~@mount @module @raw-io @debug @reboot @swap @obsolete @cpu-emulation
SystemCallErrorNumber=EPERM

# Keep the stock preflight test (donâ€™t run it with extra globals)
ExecStartPre=
ExecStartPre=/usr/sbin/nginx -t -q

