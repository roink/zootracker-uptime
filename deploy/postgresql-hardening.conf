# /etc/systemd/system/postgresql.service.d/hardening.conf

[Service]
# Core sandboxing
NoNewPrivileges=yes
RestrictSUIDSGID=yes
RestrictNamespaces=yes
PrivateTmp=yes
PrivateDevices=yes
ProtectSystem=strict
ProtectHome=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectKernelLogs=yes
ProtectControlGroups=yes
ProtectClock=yes
ProtectHostname=yes
LockPersonality=yes
RestrictRealtime=yes
SystemCallArchitectures=native
UMask=0077

# Allow writes only where Postgres legitimately needs them
# (%I expands to "15/main" on Debian/Ubuntu)
ReadWritePaths=/var/lib/postgresql/%I /var/run/postgresql /var/log/postgresql

# Capabilities: drop everything (Postgres doesn’t need Linux capabilities)
AmbientCapabilities=
CapabilityBoundingSet=

# Networking — choose ONE block:

## (A) TCP loopback + sockets
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6
IPAddressDeny=any
IPAddressAllow=127.0.0.1
IPAddressAllow=::1

## (B) Socket-only (if listen_addresses = '')
#RestrictAddressFamilies=AF_UNIX
#IPAddressDeny=any

# Seccomp: systemd's sane baseline, deny risky classes
SystemCallFilter=@system-service
SystemCallFilter=~@mount @module @raw-io @debug @reboot @swap @obsolete @privileged @cpu-emulation
SystemCallErrorNumber=EPERM

# JIT note: MemoryDenyWriteExecute breaks LLVM JIT. If you want MDWE, disable JIT in postgresql.conf (jit=off).
#MemoryDenyWriteExecute=yes

