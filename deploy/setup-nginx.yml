- hosts: zoo_server
  become: true
  vars:
    cloudflare_credentials_path: /etc/letsencrypt/cloudflare.ini
    cloudflare_dns_propagation_seconds: 60

  tasks:
    # -- myguard APT repo (adds source + pins via their .deb) --
    - name: Download myguard repo bootstrap .deb
      ansible.builtin.get_url:
        url: https://deb.myguard.nl/pool/myguard.deb
        dest: /tmp/myguard.deb
        mode: '0644'

    - name: Install myguard repo (adds list + key + pinning)
      ansible.builtin.apt:
        deb: /tmp/myguard.deb
      register: myguard_repo

    - name: apt update (after repo add)
      ansible.builtin.apt:
        update_cache: yes

    # Optional: ensure a pin to prefer myguard over Ubuntu when both provide nginx
    - name: Prefer myguard origin for nginx and modules
      ansible.builtin.copy:
        dest: /etc/apt/preferences.d/99debmyguard.nl
        mode: '0644'
        content: |
          Package: nginx nginx-core nginx-common libnginx-mod-http-zstd libnginx-mod-http-brotli
          Pin: origin deb.myguard.nl
          Pin-Priority: 700

    - name: apt update (after pin)
      ansible.builtin.apt:
        update_cache: yes

    # -- Install nginx from myguard + certbot helper --
    - name: Install nginx and TLS helpers
      ansible.builtin.apt:
        name:
          - nginx
          - certbot
          - python3-certbot-dns-cloudflare
        state: present
        update_cache: yes

    # -- Compression modules --
    - name: Remove Ubuntu Brotli modules to avoid modules-path mismatch
      ansible.builtin.apt:
        name:
          - libnginx-mod-http-brotli-filter
          - libnginx-mod-http-brotli-static
        state: absent

    - name: Install Brotli dynamic module (myguard)
      ansible.builtin.apt:
        name: libnginx-mod-http-brotli
        state: present

    # Zstd (from myguard)
    - name: Install zstd dynamic module (myguard)
      ansible.builtin.apt:
        name: libnginx-mod-http-zstd
        state: present

    - name: Show nginx build information
      ansible.builtin.command: nginx -V
      register: nginx_v
      changed_when: false

    - ansible.builtin.debug:
        msg: "{{ nginx_v.stderr }}"

    # -- Fs prep --
    - name: Ensure proxy cache directory
      ansible.builtin.file:
        path: /var/cache/nginx/zootracker
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Ensure web root exists
      ansible.builtin.file:
        path: "{{ web_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Ensure Cloudflare API token provided
      ansible.builtin.assert:
        that:
          - cloudflare_api_token | default('', true) | length > 0
        fail_msg: "cloudflare_api_token is not defined. Store it in group_vars/zoo_server.vault.yml and re-run with ansible-vault."

    - name: Install Cloudflare API credentials file for Certbot
      ansible.builtin.copy:
        dest: "{{ cloudflare_credentials_path }}"
        owner: root
        group: root
        mode: '0600'
        content: |
          dns_cloudflare_api_token = {{ cloudflare_api_token }}

    - name: Obtain certificate with certbot (Cloudflare DNS-01)
      ansible.builtin.command: >
        certbot certonly --non-interactive --agree-tos
        --dns-cloudflare
        --dns-cloudflare-credentials {{ cloudflare_credentials_path }}
        --dns-cloudflare-propagation-seconds {{ cloudflare_dns_propagation_seconds }}
        -d {{ domain }}
        -d {{ domain | regex_replace('^www\\.', '') }}
        -m contact@{{ domain | regex_replace('^www\\.', '') }}
      args:
        creates: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"

    - name: Ensure Certbot deploy hook directory exists
      ansible.builtin.file:
        path: /etc/letsencrypt/renewal-hooks/deploy
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Configure Certbot deploy hook to reload nginx
      ansible.builtin.copy:
        dest: /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh
        mode: '0755'
        owner: root
        group: root
        content: |
          #!/bin/sh
          systemctl reload nginx

    - name: Certbot renew (dry run)
      ansible.builtin.command: certbot renew --dry-run
      changed_when: false
      register: certbot_dry_run
      failed_when: certbot_dry_run.rc != 0

    # -- Final configs --
    - name: Deploy /etc/nginx/nginx.conf (loads zstd then brotli; enables cache+compression)
      ansible.builtin.template:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        mode: '0644'
      notify: reload nginx

    - name: Deploy site config
      ansible.builtin.template:
        src: templates/zoo_tracker.nginx.j2
        dest: /etc/nginx/sites-available/zoo_tracker
        mode: '0644'
      notify: reload nginx

    - name: Enable site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/zoo_tracker
        dest: /etc/nginx/sites-enabled/zoo_tracker
        state: link
        force: true
      notify: reload nginx

    - name: Ensure nginx is enabled and running
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true

    - name: Test final nginx config
      ansible.builtin.command: nginx -t
      changed_when: false

    - name: Flush handlers to activate final config
      ansible.builtin.meta: flush_handlers

    - name: Clean up myguard repo .deb
      ansible.builtin.file:
        path: /tmp/myguard.deb
        state: absent

  handlers:
    - name: reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded

- import_playbook: setup-cloudflare-realip.yml
