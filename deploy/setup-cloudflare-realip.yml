- hosts: zoo_server
  become: true

  tasks:
    - name: Install prerequisites for Cloudflare real IP sync
      ansible.builtin.apt:
        name:
          - curl
          - ca-certificates
          - coreutils    # provides the install utility
          - gawk         # awk for generating set_real_ip_from lines
        state: present
        update_cache: true
      tags: [realip]

    - name: Configure Cloudflare real IP updater
      tags: [realip]
      block:
        - name: Deploy Cloudflare real IP updater script
          ansible.builtin.template:
            src: templates/cf-realip-sync.sh.j2
            dest: /usr/local/sbin/cf-realip-sync
            mode: '0755'

        - name: Run Cloudflare real IP updater (initial sync)
          ansible.builtin.command: /usr/local/sbin/cf-realip-sync
          args:
            creates: /etc/nginx/conf.d/20-cloudflare-realip.conf

        - name: Install cf-realip-sync systemd service
          ansible.builtin.template:
            src: templates/cf-realip-sync.service.j2
            dest: /etc/systemd/system/cf-realip-sync.service
            mode: '0644'
          notify: reload systemd

        - name: Install cf-realip-sync systemd timer
          ansible.builtin.template:
            src: templates/cf-realip-sync.timer.j2
            dest: /etc/systemd/system/cf-realip-sync.timer
            mode: '0644'
          notify: reload systemd

        - name: Flush handlers to reload systemd units
          ansible.builtin.meta: flush_handlers

        - name: Ensure cf-realip-sync timer is enabled and running
          ansible.builtin.systemd:
            name: cf-realip-sync.timer
            enabled: true
            state: started

  handlers:
    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
