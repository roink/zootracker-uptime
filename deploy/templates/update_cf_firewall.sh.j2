{% raw %}#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
umask 077

# ─── Configuration ─────────────────────────────────────────────────────────────
export PATH=/usr/bin:/usr/sbin:/bin:/sbin
CF_IPV4_URL="https://www.cloudflare.com/ips-v4"
CF_IPV6_URL="https://www.cloudflare.com/ips-v6"
LOCKFILE=/var/lock/cf_ufw_update.lock
LOGFILE=/var/log/cf_ufw_update.log
STATE_DIR=/var/lib/cf_ufw_update

# ─── Lock & Logging ────────────────────────────────────────────────────────────
exec 200>"$LOCKFILE"
flock -n 200 || exit 0
exec > >(tee -a "$LOGFILE") 2>&1
export LC_ALL=C

# ─── Temp Dir & Cleanup ─────────────────────────────────────────────────────────
TMP_DIR="$(mktemp -d /tmp/cf_ufw_update.XXXXXX)"
trap 'rm -rf "$TMP_DIR"' EXIT

# ─── Fetch IP Lists ─────────────────────────────────────────────────────────────
IPV4_LIST="$TMP_DIR/ips-v4.txt"
IPV6_LIST="$TMP_DIR/ips-v6.txt"

curl -fsSL --retry 3 --retry-delay 5 "$CF_IPV4_URL" -o "$IPV4_LIST"
curl -fsSL --retry 3 --retry-delay 5 "$CF_IPV6_URL" -o "$IPV6_LIST"

[[ -s "$IPV4_LIST" ]] || { echo "Empty IPv4 list"; exit 1; }
[[ -s "$IPV6_LIST" ]] || { echo "Empty IPv6 list"; exit 1; }

# ─── Idempotency: Skip if lists are unchanged ──────────────────────────────────
mkdir -p "$STATE_DIR"
if [[ -f "$STATE_DIR/ips-v4.txt" && -f "$STATE_DIR/ips-v6.txt" ]]; then
  if cmp -s "$IPV4_LIST" "$STATE_DIR/ips-v4.txt" && cmp -s "$IPV6_LIST" "$STATE_DIR/ips-v6.txt"; then
    echo "Cloudflare IP lists unchanged; nothing to do."
    exit 0
  fi
fi

# ─── Remove Old Cloudflare Rules ────────────────────────────────────────────────
echo "Removing old Cloudflare UFW rules..."
mapfile -t CF_RULES < <(
  ufw status numbered \
    | sed -n 's/^\[\([0-9]\+\)\][[:space:]].*Cloudflare HTTP\/S.*/\1/p' \
    | sort -rn
)
if ((${#CF_RULES[@]})); then
  for number in "${CF_RULES[@]}"; do
    ufw --force delete "$number"
  done
else
  echo "No existing Cloudflare rules found."
fi

# ─── Whitelist New CF Ranges ───────────────────────────────────────────────────
echo "Adding IPv4 ranges..."
while read -r ip; do
  ufw allow proto tcp from "$ip" to any port 80,443 comment 'Cloudflare HTTP/S'
done < "$IPV4_LIST"

echo "Adding IPv6 ranges..."
while read -r ip; do
  ufw allow proto tcp from "$ip" to any port 80,443 comment 'Cloudflare HTTP/S'
done < "$IPV6_LIST"

ufw reload

# ─── Persist current lists for next run ────────────────────────────────────────
cp -f "$IPV4_LIST" "$STATE_DIR/ips-v4.txt"
cp -f "$IPV6_LIST" "$STATE_DIR/ips-v6.txt"

echo "Update complete at $(date --iso-8601=seconds)"
{% endraw %}
