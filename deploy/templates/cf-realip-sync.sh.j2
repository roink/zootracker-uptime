#!/usr/bin/env bash
set -euo pipefail

[ "${EUID}" -eq 0 ] || { echo "Run as root." >&2; exit 1; }

OUT=/etc/nginx/conf.d/20-cloudflare-realip.conf
TMP=$(mktemp)
cleanup(){ rm -f "$TMP"; }
trap cleanup EXIT

{
  echo "# generated: $(date -u) by cf-realip-sync on $(hostname -f 2>/dev/null || hostname)"
  echo "real_ip_header CF-Connecting-IP;"
  echo "real_ip_recursive on;"
  curl -fsS --retry 3 --retry-connrefused --max-time 10 \
    https://www.cloudflare.com/ips-v4 | awk '{print "set_real_ip_from "$0";"}'
  curl -fsS --retry 3 --retry-connrefused --max-time 10 \
    https://www.cloudflare.com/ips-v6 | awk '{print "set_real_ip_from "$0";"}'
} >"$TMP"

install -m 0644 "$TMP" "$OUT"
nginx -t
systemctl reload nginx
